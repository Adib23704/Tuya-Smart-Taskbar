<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
			rel="stylesheet"
		/>
		<title>Configuration</title>
		<style>
			:root {
				--bg-primary: #f8fafc;
				--bg-secondary: #ffffff;
				--bg-tertiary: #f1f5f9;
				--text-primary: #0f172a;
				--text-secondary: #475569;
				--text-muted: #94a3b8;
				--border-color: #e2e8f0;
				--border-focus: #3b82f6;
				--accent: #3b82f6;
				--accent-hover: #2563eb;
				--accent-light: rgba(59, 130, 246, 0.1);
				--success: #10b981;
				--success-hover: #059669;
				--error: #ef4444;
				--error-light: rgba(239, 68, 68, 0.1);
				--shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
				--shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
				--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
				--radius-sm: 6px;
				--radius-md: 10px;
				--radius-lg: 16px;
				--transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
			}

			[data-theme="dark"] {
				--bg-primary: #0f172a;
				--bg-secondary: #1e293b;
				--bg-tertiary: #334155;
				--text-primary: #f1f5f9;
				--text-secondary: #cbd5e1;
				--text-muted: #64748b;
				--border-color: #334155;
				--border-focus: #60a5fa;
				--accent: #60a5fa;
				--accent-hover: #3b82f6;
				--accent-light: rgba(96, 165, 250, 0.15);
				--success: #34d399;
				--success-hover: #10b981;
				--error: #f87171;
				--error-light: rgba(248, 113, 113, 0.15);
				--shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
				--shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
				--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -4px rgba(0, 0, 0, 0.3);
			}

			* {
				box-sizing: border-box;
				margin: 0;
				padding: 0;
			}

			body {
				font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
				background-color: var(--bg-primary);
				min-height: 100vh;
				color: var(--text-primary);
				transition: background-color var(--transition), color var(--transition);
			}

			/* Custom Scrollbar */
			::-webkit-scrollbar {
				width: 8px;
			}
			::-webkit-scrollbar-track {
				background: var(--bg-tertiary);
			}
			::-webkit-scrollbar-thumb {
				background: var(--text-muted);
				border-radius: 4px;
			}
			::-webkit-scrollbar-thumb:hover {
				background: var(--text-secondary);
			}

			.container {
				width: 100%;
				max-width: 420px;
				margin: 0 auto;
				padding: 24px;
			}

			/* Header with Logo */
			.header {
				text-align: center;
				margin-bottom: 28px;
			}

			.logo {
				width: 56px;
				height: 56px;
				margin: 0 auto 16px;
				background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
				border-radius: var(--radius-md);
				display: flex;
				align-items: center;
				justify-content: center;
				box-shadow: var(--shadow-md);
				animation: logoFloat 3s ease-in-out infinite;
			}

			@keyframes logoFloat {
				0%, 100% { transform: translateY(0); }
				50% { transform: translateY(-4px); }
			}

			.logo svg {
				width: 32px;
				height: 32px;
				fill: white;
			}

			.header h1 {
				font-size: 1.375rem;
				font-weight: 600;
				color: var(--text-primary);
				margin-bottom: 4px;
			}

			.header p {
				font-size: 0.875rem;
				color: var(--text-secondary);
			}

			/* Card Container */
			.card {
				background: var(--bg-secondary);
				border-radius: var(--radius-lg);
				padding: 24px;
				box-shadow: var(--shadow-md);
				border: 1px solid var(--border-color);
				transition: box-shadow var(--transition), border-color var(--transition), background-color var(--transition);
			}

			.card:hover {
				box-shadow: var(--shadow-lg);
			}

			/* Form Groups */
			.form-group {
				margin-bottom: 18px;
			}

			.form-group label {
				display: block;
				font-size: 0.8125rem;
				font-weight: 500;
				color: var(--text-secondary);
				margin-bottom: 8px;
				transition: color var(--transition);
			}

			.input-wrapper {
				position: relative;
			}

			.form-group select,
			.form-group input[type="text"],
			.form-group input[type="password"] {
				width: 100%;
				padding: 11px 14px;
				font-size: 0.9375rem;
				font-family: inherit;
				border: 1.5px solid var(--border-color);
				border-radius: var(--radius-sm);
				background-color: var(--bg-secondary);
				color: var(--text-primary);
				transition: all var(--transition);
				outline: none;
			}

			.form-group input[type="text"]::placeholder,
			.form-group input[type="password"]::placeholder {
				color: var(--text-muted);
			}

			.form-group select:hover,
			.form-group input[type="text"]:hover,
			.form-group input[type="password"]:hover {
				border-color: var(--text-muted);
			}

			.form-group select:focus,
			.form-group input[type="text"]:focus,
			.form-group input[type="password"]:focus {
				border-color: var(--border-focus);
				box-shadow: 0 0 0 3px var(--accent-light);
			}

			/* Validation States */
			.form-group.error input {
				border-color: var(--error);
				background-color: var(--error-light);
			}

			.form-group.error input:focus {
				box-shadow: 0 0 0 3px var(--error-light);
			}

			.form-group.success input {
				border-color: var(--success);
			}

			.error-message {
				font-size: 0.75rem;
				color: var(--error);
				margin-top: 6px;
				display: none;
				animation: slideDown 0.2s ease;
			}

			.form-group.error .error-message {
				display: block;
			}

			@keyframes slideDown {
				from { opacity: 0; transform: translateY(-4px); }
				to { opacity: 1; transform: translateY(0); }
			}

			/* Password Toggle */
			.password-toggle {
				position: absolute;
				right: 12px;
				top: 50%;
				transform: translateY(-50%);
				background: none;
				border: none;
				cursor: pointer;
				color: var(--text-muted);
				padding: 4px;
				display: flex;
				align-items: center;
				justify-content: center;
				transition: color var(--transition);
			}

			.password-toggle:hover {
				color: var(--text-secondary);
			}

			.password-toggle svg {
				width: 18px;
				height: 18px;
			}

			.form-group input[type="password"],
			.form-group input[type="text"].has-toggle {
				padding-right: 42px;
			}

			/* Select Styling */
			.form-group select {
				cursor: pointer;
				appearance: none;
				background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
				background-repeat: no-repeat;
				background-position: right 12px center;
				padding-right: 40px;
			}

			/* Checkbox Styling */
			.checkbox-group {
				display: flex;
				align-items: center;
				gap: 12px;
				padding: 12px 14px;
				background: var(--bg-tertiary);
				border-radius: var(--radius-sm);
				cursor: pointer;
				transition: background-color var(--transition);
			}

			.checkbox-group:hover {
				background: var(--border-color);
			}

			.checkbox-wrapper {
				position: relative;
				width: 20px;
				height: 20px;
			}

			.checkbox-wrapper input {
				position: absolute;
				opacity: 0;
				width: 100%;
				height: 100%;
				cursor: pointer;
			}

			.checkmark {
				position: absolute;
				top: 0;
				left: 0;
				width: 20px;
				height: 20px;
				background: var(--bg-secondary);
				border: 2px solid var(--border-color);
				border-radius: 4px;
				transition: all var(--transition);
			}

			.checkbox-wrapper input:checked ~ .checkmark {
				background: var(--accent);
				border-color: var(--accent);
			}

			.checkmark:after {
				content: "";
				position: absolute;
				display: none;
				left: 6px;
				top: 2px;
				width: 5px;
				height: 10px;
				border: solid white;
				border-width: 0 2px 2px 0;
				transform: rotate(45deg);
			}

			.checkbox-wrapper input:checked ~ .checkmark:after {
				display: block;
			}

			.checkbox-group label {
				font-size: 0.9375rem;
				color: var(--text-primary);
				cursor: pointer;
				user-select: none;
				flex: 1;
			}

			/* Button Group */
			.button-group {
				display: flex;
				gap: 12px;
				margin-top: 24px;
			}

			button {
				flex: 1;
				padding: 12px 18px;
				font-size: 0.9375rem;
				font-family: inherit;
				font-weight: 600;
				border: none;
				border-radius: var(--radius-sm);
				cursor: pointer;
				transition: all var(--transition);
				display: flex;
				align-items: center;
				justify-content: center;
				gap: 8px;
			}

			button:active:not(:disabled) {
				transform: scale(0.98);
			}

			button svg {
				width: 18px;
				height: 18px;
			}

			.test-btn {
				background-color: var(--bg-tertiary);
				color: var(--text-primary);
				border: 1.5px solid var(--border-color);
			}

			.test-btn:hover:not(:disabled) {
				background-color: var(--border-color);
				border-color: var(--text-muted);
			}

			.save-btn {
				background-color: var(--accent);
				color: white;
			}

			.save-btn:hover:not(:disabled) {
				background-color: var(--accent-hover);
			}

			button:disabled {
				opacity: 0.6;
				cursor: not-allowed;
			}

			button.success {
				background-color: var(--success) !important;
				border-color: var(--success) !important;
				color: white !important;
			}

			button.error {
				background-color: var(--error) !important;
				border-color: var(--error) !important;
				color: white !important;
			}

			/* Loading Spinner */
			.spinner {
				width: 18px;
				height: 18px;
				border: 2px solid transparent;
				border-top-color: currentColor;
				border-radius: 50%;
				animation: spin 0.8s linear infinite;
			}

			@keyframes spin {
				to { transform: rotate(360deg); }
			}

			/* Status Message */
			.status-message {
				margin-top: 16px;
				padding: 12px 14px;
				border-radius: var(--radius-sm);
				font-size: 0.875rem;
				display: none;
				animation: slideDown 0.2s ease;
			}

			.status-message.show {
				display: flex;
				align-items: center;
				gap: 10px;
			}

			.status-message.success {
				background-color: rgba(16, 185, 129, 0.1);
				color: var(--success);
				border: 1px solid var(--success);
			}

			.status-message.error {
				background-color: var(--error-light);
				color: var(--error);
				border: 1px solid var(--error);
			}

			.status-message svg {
				width: 18px;
				height: 18px;
				flex-shrink: 0;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="header">
				<div class="logo">
					<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
						<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
					</svg>
				</div>
				<h1>Tuya Smart Taskbar</h1>
				<p>Configure your smart home connection</p>
			</div>

			<div class="card">
				<form id="configForm" autocomplete="off">
					<div class="form-group">
						<label for="baseUrl">Region</label>
						<select id="baseUrl">
							<option value="https://openapi.tuyaeu.com" selected>Central Europe</option>
							<option value="https://openapi.tuyacn.com">China</option>
							<option value="https://openapi.tuyaus.com">Western America</option>
							<option value="https://openapi-ueaz.tuyaus.com">Eastern America</option>
							<option value="https://openapi-weaz.tuyaeu.com">Western Europe</option>
							<option value="https://openapi.tuyain.com">India</option>
							<option value="https://openapi-sg.iotbing.com">Singapore</option>
						</select>
					</div>

					<div class="form-group" id="accessKeyGroup">
						<label for="accessKey">Access Key</label>
						<input
							type="text"
							id="accessKey"
							placeholder="Enter your access key"
							spellcheck="false"
						/>
						<div class="error-message">Access key is required</div>
					</div>

					<div class="form-group" id="secretKeyGroup">
						<label for="secretKey">Secret Key</label>
						<div class="input-wrapper">
							<input
								type="password"
								id="secretKey"
								placeholder="Enter your secret key"
								spellcheck="false"
							/>
							<button type="button" class="password-toggle" id="toggleSecret" aria-label="Toggle password visibility">
								<svg id="eyeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
									<circle cx="12" cy="12" r="3"></circle>
								</svg>
								<svg id="eyeOffIcon" style="display:none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
									<line x1="1" y1="1" x2="23" y2="23"></line>
								</svg>
							</button>
						</div>
						<div class="error-message">Secret key is required</div>
					</div>

					<div class="form-group" id="userIdGroup">
						<label for="userId">User ID</label>
						<input
							type="text"
							id="userId"
							placeholder="Enter your user ID"
							spellcheck="false"
						/>
						<div class="error-message">User ID is required</div>
					</div>

					<div class="checkbox-group" onclick="document.getElementById('runOnStartup').click()">
						<div class="checkbox-wrapper">
							<input type="checkbox" id="runOnStartup" checked onclick="event.stopPropagation()" />
							<span class="checkmark"></span>
						</div>
						<label for="runOnStartup" onclick="event.stopPropagation()">Run on Windows startup</label>
					</div>

					<div class="button-group">
						<button id="test-btn" type="button" class="test-btn">
							<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
								<polyline points="22 4 12 14.01 9 11.01"></polyline>
							</svg>
							<span>Test</span>
						</button>
						<button id="save-btn" type="button" class="save-btn">
							<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
								<polyline points="17 21 17 13 7 13 7 21"></polyline>
								<polyline points="7 3 7 8 15 8"></polyline>
							</svg>
							<span>Save</span>
						</button>
					</div>

					<div class="status-message" id="statusMessage">
						<svg id="statusIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
							<polyline points="22 4 12 14.01 9 11.01"></polyline>
						</svg>
						<span id="statusText"></span>
					</div>
				</form>
			</div>
		</div>
		<script>
			const { invoke } = window.__TAURI__.core;

			// Elements
			const baseUrlSelect = document.getElementById('baseUrl');
			const accessKeyInput = document.getElementById('accessKey');
			const secretKeyInput = document.getElementById('secretKey');
			const userIdInput = document.getElementById('userId');
			const runOnStartupCheckbox = document.getElementById('runOnStartup');
			const saveButton = document.getElementById('save-btn');
			const testButton = document.getElementById('test-btn');
			const toggleSecretBtn = document.getElementById('toggleSecret');
			const eyeIcon = document.getElementById('eyeIcon');
			const eyeOffIcon = document.getElementById('eyeOffIcon');
			const statusMessage = document.getElementById('statusMessage');
			const statusText = document.getElementById('statusText');
			const statusIcon = document.getElementById('statusIcon');

			// Detect system theme
			function detectTheme() {
				if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
					document.documentElement.setAttribute('data-theme', 'dark');
				} else {
					document.documentElement.removeAttribute('data-theme');
				}
			}

			// Listen for theme changes
			window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', detectTheme);

			// Toggle password visibility
			toggleSecretBtn.addEventListener('click', () => {
				const isPassword = secretKeyInput.type === 'password';
				secretKeyInput.type = isPassword ? 'text' : 'password';
				eyeIcon.style.display = isPassword ? 'none' : 'block';
				eyeOffIcon.style.display = isPassword ? 'block' : 'none';
			});

			// Validation
			function validateField(input, groupId) {
				const group = document.getElementById(groupId);
				const value = input.value.trim();

				if (!value) {
					group.classList.add('error');
					group.classList.remove('success');
					return false;
				} else {
					group.classList.remove('error');
					group.classList.add('success');
					return true;
				}
			}

			function validateAll() {
				const accessValid = validateField(accessKeyInput, 'accessKeyGroup');
				const secretValid = validateField(secretKeyInput, 'secretKeyGroup');
				const userValid = validateField(userIdInput, 'userIdGroup');
				return accessValid && secretValid && userValid;
			}

			// Clear validation on input
			accessKeyInput.addEventListener('input', () => {
				document.getElementById('accessKeyGroup').classList.remove('error');
			});
			secretKeyInput.addEventListener('input', () => {
				document.getElementById('secretKeyGroup').classList.remove('error');
			});
			userIdInput.addEventListener('input', () => {
				document.getElementById('userIdGroup').classList.remove('error');
			});

			// Show status message
			function showStatus(message, isSuccess) {
				statusMessage.className = 'status-message show ' + (isSuccess ? 'success' : 'error');
				statusText.textContent = message;

				if (isSuccess) {
					statusIcon.innerHTML = '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>';
				} else {
					statusIcon.innerHTML = '<circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>';
				}
			}

			function hideStatus() {
				statusMessage.className = 'status-message';
			}

			// Set button state
			function setButtonState(button, state, text) {
				const span = button.querySelector('span');
				const svg = button.querySelector('svg:not(.spinner)');

				button.classList.remove('success', 'error');

				if (state === 'loading') {
					button.disabled = true;
					if (svg) svg.style.display = 'none';
					if (!button.querySelector('.spinner')) {
						const spinner = document.createElement('div');
						spinner.className = 'spinner';
						button.insertBefore(spinner, span);
					}
					span.textContent = text;
				} else {
					button.disabled = false;
					if (svg) svg.style.display = 'block';
					const spinner = button.querySelector('.spinner');
					if (spinner) spinner.remove();
					span.textContent = text;

					if (state === 'success') button.classList.add('success');
					if (state === 'error') button.classList.add('error');
				}
			}

			// Test connection
			async function testConnection() {
				if (!validateAll()) {
					showStatus('Please fill in all required fields', false);
					return;
				}

				hideStatus();
				setButtonState(testButton, 'loading', 'Testing...');

				try {
					// Save config temporarily and try to fetch devices
					const config = {
						baseUrl: baseUrlSelect.value,
						accessKey: accessKeyInput.value.trim(),
						secretKey: secretKeyInput.value.trim(),
						userId: userIdInput.value.trim(),
						runOnStartup: runOnStartupCheckbox.checked,
					};

					await invoke('save_config', { newConfig: config });
					const devices = await invoke('fetch_devices');

					setButtonState(testButton, 'success', 'Connected!');
					showStatus(`Connection successful! Found ${devices.length} device(s)`, true);

					setTimeout(() => {
						setButtonState(testButton, 'normal', 'Test');
					}, 3000);
				} catch (error) {
					console.error('Connection test failed:', error);
					setButtonState(testButton, 'error', 'Failed');
					showStatus('Connection failed. Please check your credentials.', false);

					setTimeout(() => {
						setButtonState(testButton, 'normal', 'Test');
					}, 3000);
				}
			}

			// Save config
			async function saveConfig() {
				if (!validateAll()) {
					showStatus('Please fill in all required fields', false);
					return;
				}

				hideStatus();
				setButtonState(saveButton, 'loading', 'Saving...');

				const config = {
					baseUrl: baseUrlSelect.value,
					accessKey: accessKeyInput.value.trim(),
					secretKey: secretKeyInput.value.trim(),
					userId: userIdInput.value.trim(),
					runOnStartup: runOnStartupCheckbox.checked,
				};

				try {
					await invoke('save_config', { newConfig: config });
					setButtonState(saveButton, 'success', 'Saved!');
					showStatus('Configuration saved successfully!', true);

					setTimeout(() => {
						setButtonState(saveButton, 'normal', 'Save');
						hideStatus();
					}, 3000);
				} catch (error) {
					console.error('Failed to save config:', error);
					setButtonState(saveButton, 'error', 'Error');
					showStatus('Failed to save configuration', false);

					setTimeout(() => {
						setButtonState(saveButton, 'normal', 'Save');
					}, 3000);
				}
			}

			function loadConfig(config) {
				baseUrlSelect.value = config.baseUrl || 'https://openapi.tuyaeu.com';
				accessKeyInput.value = config.accessKey || '';
				secretKeyInput.value = config.secretKey || '';
				userIdInput.value = config.userId || '';
				runOnStartupCheckbox.checked = config.runOnStartup ?? true;
			}

			async function init() {
				detectTheme();

				saveButton.addEventListener('click', saveConfig);
				testButton.addEventListener('click', testConnection);

				try {
					const config = await invoke('get_config');
					loadConfig(config);
				} catch (error) {
					console.error('Failed to load config:', error);
				}
			}

			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', init);
			} else {
				init();
			}
		</script>
	</body>
</html>
